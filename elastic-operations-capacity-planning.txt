[[chapter-elastic-ops-capacity-planning]]

// tag::elastic-ops-cp-create-template[]
PUT /_template/template_capacity_planning
{
  "index_patterns" : ["tp_elastic_g*"],
  "settings":
  {
    "number_of_shards": 1,
    "number_of_replicas": 0
  }
}
// end::elastic-ops-cp-create-template[]


##### Load Data

// tag::elastic-ops-cp-load-data[]
./bin/logstash   -f ./<$PATH_TO>/ls-google-playstore.conf
// end::elastic-ops-cp-load-data[]

##### Index check


##### Mapping control
// tag::elastic-ops-cp-index-get[]
GET tp_elastic_gstore
// end::elastic-ops-cp-index-get[]


// tag::elastic-ops-cp-index-infered-mapping[]
{
  "tp_elastic_gstore_v1" : {
    "aliases" : {
      "tp_elastic_gstore" : { }
    },
    "mappings" : {
      "properties" : {
        "@timestamp" : {
          "type" : "date"
        },
        "android_ver" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        },
        "app_name" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        },
        "category" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        },
        "content_rating" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        },
        "current_ver" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        },
        "genres" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        },
        "installs" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        },
        "last_updated" : {
          "type" : "date"
        },
        "price" : {
          "type" : "float"
        },
        "rating" : {
          "type" : "float"
        },
        "reviews" : {
          "type" : "long"
        },
        "size" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        },
        "type" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 256
            }
          }
        }
      }
    },
    "settings" : {
      "index" : {
        "creation_date" : "1596654184472",
        "number_of_shards" : "1",
        "number_of_replicas" : "1",
        "uuid" : "XQc5AfAQQ6aB5aRzvJuquA",
        "version" : {
          "created" : "7030199"
        },
        "provided_name" : "tp_elastic_gstore_v1"
      }
    }
  }
}
// end::elastic-ops-cp-index-infered-mapping[]

##### Count
// tag::elastic-ops-cp-index-count[]
GET tp_elastic_gstore/_count
// end::elastic-ops-cp-index-count[]

##### flush
// tag::elastic-ops-cp-index-flush[]
GET tp_elastic_gstore/_flush
// end::elastic-ops-cp-index-flush[]

###### force merge pour ne plus avoir qu'un seul segment
// tag::elastic-ops-cp-index-force-merge[]
POST /tp_elastic_gstore/_forcemerge?max_num_segments=1
// end::elastic-ops-cp-index-force-merge[]


#### Faites une statistique rapide de la taille de l'unique shard pour cet index (api _cat)

##### Query
// tag::elastic-ops-cp-index-cat-on-shards-query[]
GET /_cat/shards/tp_elastic_gstore?v&h=index,shard,prirep,state,docs,store
// end::elastic-ops-cp-index-cat-on-shards-query[]

##### Réponse
// tag::elastic-ops-cp-index-v0-cat-on-shards-answer[]
index                shard prirep state     docs  store
tp_elastic_gstore_v0 0     p      STARTED 100000 14.5mb
// end::elastic-ops-cp-index-v0-cat-on-shards-answer[]


#### Faites une statistique détaillée des caractéristiques de ce index (api _stats)

// tag::elastic-ops-cp-index-stats-query[]
GET /tp_elastic_gstore/_stats
// end::elastic-ops-cp-index-stats-query[]



#### Résultats

// tag::elastic-ops-cp-index-stats-synthetic-results[]
**  100.000 documents      =>  15108285  bytes
**  100.000.000 documents  =>  (15108285*1000) / (1024*1024*1024) = 14,07  gb
**  pendant  30 jours      => 422 gb
// end::elastic-ops-cp-index-stats-synthetic-results[]



### Index personnalisé 2

Pour les index dont le mapping n'est pas inféré (au moins en partie), la procédure est la suivante

##### Supprimer les index précédents
// tag::elastic-ops-cp-index-delete[]
DELETE tp_elastic_gstore_v*
// end::elastic-ops-cp-index-delete[]

##### Créer l'index avec le mapping fourni
```json
PUT tp_elastic_gstore_vx
{
  "mappings":
  {
        "properties" :
        {
          ...
        }
  }
}
```

##### Créer l'alias
* Remplacer le x par la version de l'index testé

// tag::elastic-ops-cp-index-alias-v1[]
POST /_aliases
{
    "actions" : [
        { "add" : { "index" : "tp_elastic_gstore_v1", "alias" : "tp_elastic_gstore" } }
    ]
}
// end::elastic-ops-cp-index-alias-v1[]


// tag::elastic-ops-cp-index-alias-v2[]
POST /_aliases
{
    "actions" : [
        { "add" : { "index" : "tp_elastic_gstore_v2", "alias" : "tp_elastic_gstore" } }
    ]
}
// end::elastic-ops-cp-index-alias-v2[]


// tag::elastic-ops-cp-index-alias-v5[]
POST /_aliases
{
    "actions" : [
        { "add" : { "index" : "tp_elastic_gstore_v5", "alias" : "tp_elastic_gstore" } }
    ]
}
// end::elastic-ops-cp-index-alias-v5[]


// tag::elastic-ops-cp-index-alias-v0[]
POST /_aliases
{
    "actions" : [
        { "add" : { "index" : "tp_elastic_gstore_v0", "alias" : "tp_elastic_gstore" } }
    ]
}
// end::elastic-ops-cp-index-alias-v0[]

##### Charger les données
```shell script
./bin/logstash   -f ./<$PATH_TO>/ls-google-playstore.conf
```

Pour l'index personnalisé 2, les résultats sont indiqués ci-dessous
* 7.3.1
    *  100.000        =>  17858883  bytes
    *  100.000.000    =>  (17858883*1000) / (1024*1024*1024) = 16,63  gb
    *  pendant  30 jours 499 gb


* *7.6.2
    *  100.000        =>  17335363  bytes
    *  100.000.000    =>  (17335363*1000) / (1024*1024*1024) = 16,10  gb
    *  pendant  30 jours 480 gb



### Index personnalisé 3
* 7.3.1
    *  100.000        =>  27879840  bytes
    *  100.000.000    =>  (27879840*1000) / (1024*1024*1024) = 25,96  gb
    *  pendant  30 jours 779 gb

* 7.6.2
    *  100.000        =>  27277207  bytes
    *  100.000.000    =>  (27277207*1000) / (1024*1024*1024) = 25,4  gb
    *  pendant  30 jours 750 gb


### Index personnalisé 4
* 7.3.1
    *  100.000        =>  15108285  bytes
    *  100.000.000    =>  (15108285*1000) / (1024*1024*1024) = 14,07  gb
    *  pendant  30 jours 422 gb

* 7.6.2
    *  100.000        =>  14682805  bytes
    *  100.000.000    =>  (14682805*1000) / (1024*1024*1024) = 13,6  gb
    *  pendant  30 jours 410 gb


### Mapping inféré
* ES Version 7.3.1
    *  100.000            =>  17522189 bytes
    *  100.000.000        =>  (17522189*1000) / (1024*1024*1024) = 16,3  gb
    *  pendant  30 jours  =>  489 gb

* ES Version 7.6.2
    *  100.000        =>  17049761 bytes
    *  100.000.000    =>  (17049761*1000) / (1024*1024*1024) = 15,9  gb
    *  pendant  30 jours 476 gb


### Bilan
Bilan des résultats (version ES 7.6.2)

|===
|Type de mapping | Numéro index | Espace disque (GB)

| Mapping personnalisé simple
| Test 1
| 410

| Mapping inféré
| Test 2
| 476

| Mapping mixte simple
| Test 3
| 480

| Mapping mixte complexe
| Test 4
| 750
|===


// tag::elastic-ops-synthese[]
|===
|Type de mapping | Test | Espace disque (GB)

| Mapping personnalisé simple
| Test 1
| 422

| Mapping inféré
| Test 2
| 489

| Mapping mixte simple
| Test 3
| 499

| Mapping mixte complexe
| Test 4
| 779
|===

(*) : Mapping mixte = Mapping personnalisé pour certains champs et inféré pour les autres.
// end::elastic-ops-synthese[]

